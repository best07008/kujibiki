# デプロイメントガイド

## 環境別の永続化ストレージ

このアプリケーションは、Vercel KV（Redis互換）を使用してセッションデータを永続化しています。

### 開発環境（ローカル）

開発環境ではメモリ内のKVストア（InMemoryKVStore）を使用します。この場合、セッションデータはプロセス内に保持されます。

**設定**: 自動（デフォルト）
- `npm run dev`を実行するだけで動作します
- `VERCEL`環境変数が設定されていない場合、自動的にメモリストアが使用されます

### 本番環境（Vercel）

Vercelにデプロイする場合、以下の手順に従ってください：

#### 1. Vercel KVの設定

```bash
# Vercel CLIをインストール
npm i -g vercel

# Vercelにログイン
vercel login

# プロジェクトをリンク
vercel link
```

#### 2. Vercel KVの作成

Vercel ダッシュボード（https://vercel.com/dashboard）から：

1. **Storage** タブをクリック
2. **Create Database** をクリック
3. **Redis** を選択
4. プロジェクトを選択して作成

#### 3. 環境変数の設定

Vercel KVを作成すると、以下の環境変数が自動的に追加されます：

- `KV_REST_API_URL`
- `KV_REST_API_TOKEN`

これらの変数は自動的に`.env.local`に追加されます。

#### 4. デプロイ

```bash
# Vercelにデプロイ
vercel deploy --prod
```

### Vercel環境変数の確認

デプロイ後、Vercel ダッシュボードで環境変数を確認：

1. プロジェクト → Settings → Environment Variables
2. `KV_REST_API_URL`と`KV_REST_API_TOKEN`があることを確認

## セッション永続化の詳細

### セッションの保存

セッションは以下のタイミングで自動的にVercel KVに保存されます：

- セッション作成時
- 参加者が参加したとき
- 参加者が準備完了をマークしたとき
- セッション開始時（結果割り当て完了時）

### セッション有効期限

セッションデータは**24時間のTTL（Time To Live）**で保存されます。つまり：

- 最後の更新から24時間以内のセッションは有効です
- 24時間以上更新されないセッションは自動削除されます

### フォールバック動作

開発環境またはKVが利用できない場合：

- インメモリストア（メモリ内保存）にフォールバックします
- 機能的には変わりませんが、プロセス再起動でセッションが消失します

## トラブルシューティング

### セッションが見つからない場合

1. **開発環境で複数プロセス**を実行していないか確認
   - 各プロセスは独立したメモリストアを持ちます
   - `npm run dev`は1つのプロセスで実行してください

2. **Vercel環境変数**が正しく設定されているか確認
   ```bash
   vercel env list
   ```

3. **KV接続エラー**をチェック
   - サーバーログで`[KVStore]`から始まるメッセージを確認
   - 接続エラーはインメモリストアにフォールバックします

### セッションデータが失われた場合

**ローカル開発**：
- サーバーを再起動するとセッションが消失します（期待動作）
- セッションIDを保存して、データベースから復旧することはできません

**Vercel本番環境**：
- 24時間以内のセッションはKVに保存されます
- サーバーの再起動やデプロイでもセッションは保持されます

## セッションデータ構造

KVに保存されるセッションオブジェクト：

```json
{
  "id": "ABC123",
  "participantCount": 10,
  "participants": [
    ["participant-id-1", {
      "id": "participant-id-1",
      "name": "Alice",
      "position": 1,
      "ready": true,
      "result": "A"
    }],
    ...
  ],
  "started": true,
  "results": [
    ["participant-id-1", "A"],
    ["participant-id-2", "B"],
    ...
  ],
  "selectedPositions": [1, 2, 3, ...],
  "createdAt": "2025-11-04T12:00:00.000Z",
  "updatedAt": "2025-11-04T12:05:00.000Z"
}
```

## パフォーマンス考慮事項

### メモリ内ストア（開発環境）

- **メリット**: 高速、レイテンシーなし
- **デメリット**: プロセス再起動で喪失、スケーリング不可

### Vercel KV（本番環境）

- **メリット**: 永続的、複数インスタンスで共有可能
- **デメリット**: ネットワークレイテンシー発生
- **キャッシュ戦略**: セッションはメモリに保持し、Webアプリケーションスケーリングは設計済み

## 今後のスケーリング

より大規模な運用の場合、以下を検討してください：

1. **PostgreSQL + Prisma**: 全データベース履歴が必要な場合
2. **Redis Cluster**: 超高スケール（数千ユーザー）の場合
3. **Firestore**: ファイアウォール要件がある場合
